// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\.gitignore ==========
# These are some examples of commonly ignored file patterns.
# You should customize this list as applicable to your project.
# Learn more about .gitignore:
#     https://www.atlassian.com/git/tutorials/saving-changes/gitignore

# Node artifact files
node_modules/

# Compiled Java class files
*.class

# Compiled Python bytecode
*.py[cod]

# Log files
*.log

# Package files
*.jar

# Maven
target/
dist/
obj/
bin/
# JetBrains IDE
.idea/

# Unit test reports
TEST*.xml

# Generated by MacOS
.DS_Store

# Generated by Windows
Thumbs.db

*.dll
# Applications
*.app
*.exe
*.war

# Large media files
*.mp4
*.tiff
*.avi
*.flv
*.mov
*.wmv

.nx/
.angular/

# eleoncore
# eleoncoreelsa
# eleonsphere
# immunities
# eleoncoreshared
# eleoncore-manager
# eloncoreproxy
# docs
# EleonCoreDevDocs
# EleonCoreDocs
abp
custom-abp
vcportal
vportal.version
wwwroot/
release/
obj/
**/.vs/
# /eleoncore/
# /eleonsphere/
# /eleoncoreelsa/
# /immunities/
# /eleoncoreshared/
# /eloncoreproxy/

shared/

/Data/

**/module.manifest.json
**/appsettings.Debug.json
**/appsettings.ImmuRelease.json
**/tempkey.rsa
**/tempkey.jwk

dasdasda

.angular

.cursor\rules\nx-rules.mdc
.github\instructions\nx.instructions.md

.vs/
/server/hosts/eleonsoft/version.txt
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\.gitignore ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\appsettings.json ==========
{
  "S3": {
    "Endpoint": "https://localhost:5560",
    "BucketName": "grafana",
    "Region": "us-east-1",
    "AccessKey": "TENANT_A_KEY",
    "SecretKey": "TENANT_A_SECRET",
    "UseHttp": true,
    "ForcePathStyle": true
  }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\appsettings.json ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\EleonS3.Test.csproj ==========
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="AWSSDK.S3" Version="4.0.7.14" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="9.0.10" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="9.0.10" />
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="18.0.0" />
    <PackageReference Include="xunit" Version="2.9.3" />
    <PackageReference Include="xunit.runner.visualstudio" Version="3.1.5">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <None Update="appsettings.json">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>

</Project>
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\EleonS3.Test.csproj ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3AuthTests.cs ==========
using Xunit;
using Amazon.S3;
using Amazon.S3.Model;
using Amazon.Runtime;
using Microsoft.Extensions.Configuration;
using System.Net;

namespace EleonS3.Test.Tests;

public class S3AuthTests
{
    private readonly string _endpoint;
    private readonly string _bucket;
    private readonly string _region;
    private readonly string _validAccessKey;
    private readonly string _validSecretKey;

    public S3AuthTests()
    {
        var config = new ConfigurationBuilder()
            .AddJsonFile("appsettings.json", optional: false)
            .Build();

        var section = config.GetSection("S3");
        _endpoint = section["Endpoint"]!;
        _bucket = section["BucketName"]!;
        _region = section["Region"]!;
        _validAccessKey = section["AccessKey"]!;
        _validSecretKey = section["SecretKey"]!;
    }

    private static IAmazonS3 CreateClient(string endpoint, string region, string accessKey, string secretKey)
    {
        var credentials = new BasicAWSCredentials(accessKey, secretKey);
        var config = new AmazonS3Config
        {
            ServiceURL = endpoint,
            ForcePathStyle = true,
            UseHttp = true,
            RegionEndpoint = Amazon.RegionEndpoint.GetBySystemName(region)
        };
        return new AmazonS3Client(credentials, config);
    }

    [Fact(DisplayName = "Valid credentials should allow S3 operations")]
    public async Task ValidCredentials_ShouldSucceed()
    {
        var client = CreateClient(_endpoint, _region, _validAccessKey, _validSecretKey);

        // Try listing buckets — any signed request will do
        var response = await client.ListBucketsAsync();

        Assert.NotNull(response);
        Assert.NotEmpty(response.Buckets);
    }

    [Fact(DisplayName = "Invalid credentials should return 403 Forbidden")]
    public async Task InvalidCredentials_ShouldFail()
    {
        var client = CreateClient(_endpoint, _region, "INVALID_KEY", "INVALID_SECRET");

        // We expect an AmazonS3Exception
        var ex = await Assert.ThrowsAsync<AmazonS3Exception>(async () =>
        {
            await client.ListBucketsAsync();
        });

        // Verify the server rejected the request
        Assert.True(
            ex.StatusCode == HttpStatusCode.Forbidden || ex.StatusCode == HttpStatusCode.Unauthorized,
            $"Expected 403 or 401, got {(int)ex.StatusCode} ({ex.StatusCode})"
        );
    }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3AuthTests.cs ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3BasicTests.cs ==========
using Amazon.S3;
using Amazon.S3.Model;
using Microsoft.Extensions.Configuration;
using Xunit;

namespace EleonS3.Test.Tests;

public class S3BasicTests
{
    private readonly IAmazonS3 _s3;
    private readonly string _bucket;

    public S3BasicTests()
    {
        var config = new ConfigurationBuilder()
            .AddJsonFile("appsettings.json")
            .Build();

        _s3 = S3TestClient.Create(config);
        _bucket = config["S3:BucketName"]!;
    }

    [Fact]
    public async Task CanPutAndGetObject()
    {
        var key = "test/hello.txt";
        var content = "Hello from Eleonsoft S3 mock";

        await _s3.PutObjectAsync(new PutObjectRequest
        {
            BucketName = _bucket,
            Key = key,
            ContentBody = content
        });

        var get = await _s3.GetObjectAsync(_bucket, key);
        using var reader = new StreamReader(get.ResponseStream);
        var result = await reader.ReadToEndAsync();

        Assert.Equal(content, result);
    }

    [Fact]
    public async Task CanListObjects()
    {
        var response = await _s3.ListObjectsV2Async(new ListObjectsV2Request
        {
            BucketName = _bucket,
            Prefix = "test/"
        });

        Assert.NotNull(response);
        Assert.True(response.S3Objects.Count > 0, "Expected at least one object in 'test/' prefix");
    }

    [Fact]
    public async Task CanDeleteObject()
    {
        var key = "test/delete_me.txt";
        await _s3.PutObjectAsync(new PutObjectRequest
        {
            BucketName = _bucket,
            Key = key,
            ContentBody = "to be deleted"
        });

        await _s3.DeleteObjectAsync(_bucket, key);

        var list = await _s3.ListObjectsV2Async(new ListObjectsV2Request
        {
            BucketName = _bucket,
            Prefix = key
        });

        Assert.Empty(list.S3Objects);
    }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3BasicTests.cs ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3BucketTests.cs ==========
using Amazon.S3;
using Amazon.S3.Model;
using Microsoft.Extensions.Configuration;
using Xunit;

namespace EleonS3.Test.Tests;

public class S3BucketTests
{
    private readonly IAmazonS3 _s3;

    public S3BucketTests()
    {
        var config = new ConfigurationBuilder()
            .AddJsonFile("appsettings.json")
            .Build();

        _s3 = S3TestClient.Create(config);
    }

    [Fact]
    public async Task CanListBuckets()
    {
        var buckets = await _s3.ListBucketsAsync();
        Assert.NotNull(buckets);
        Assert.NotEmpty(buckets.Buckets);
    }

    [Fact]
    public async Task CanCreateAndDeleteBucket()
    {
        var bucketName = $"testbucket-{Guid.NewGuid():N}".ToLower();

        await _s3.PutBucketAsync(bucketName);
        var buckets = await _s3.ListBucketsAsync();
        var exists = buckets.Buckets.Any(b => b.BucketName == bucketName);

        Assert.True(exists, $"Expected bucket '{bucketName}' to exist after creation.");

        await _s3.DeleteBucketAsync(bucketName);
        var bucketsAfterDelete = await _s3.ListBucketsAsync();
        var stillExists = bucketsAfterDelete.Buckets.Any(b => b.BucketName == bucketName);

        Assert.False(stillExists, $"Expected bucket '{bucketName}' to be deleted.");
    }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3BucketTests.cs ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3MultipartTests.cs ==========
using Amazon.S3;
using Amazon.S3.Model;
using EleonS3.Test.Tests;
using Microsoft.Extensions.Configuration;
using Xunit;

namespace Eleonsoft.S3CompatibilityTests.Tests;

public class S3MultipartTests
{
    private readonly IAmazonS3 _s3;
    private readonly string _bucket;

    public S3MultipartTests()
    {
        var config = new ConfigurationBuilder()
            .AddJsonFile("appsettings.json")
            .Build();

        _s3 = S3TestClient.Create(config);
        _bucket = config["S3:BucketName"]!;
    }

    [Fact]
    public async Task CanUploadMultipart()
    {
        var key = "multipart/large-object.txt";
        var init = await _s3.InitiateMultipartUploadAsync(new InitiateMultipartUploadRequest
        {
            BucketName = _bucket,
            Key = key
        });

        var content = new string('A', 6 * 1024 * 1024); // 6MB
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);

        var upload = await _s3.UploadPartAsync(new UploadPartRequest
        {
            BucketName = _bucket,
            Key = key,
            UploadId = init.UploadId,
            PartNumber = 1,
            InputStream = new MemoryStream(bytes),
            PartSize = bytes.Length
        });

        await _s3.CompleteMultipartUploadAsync(new CompleteMultipartUploadRequest
        {
            BucketName = _bucket,
            Key = key,
            UploadId = init.UploadId,
            PartETags = new List<PartETag>
            {
                new PartETag(1, upload.ETag)
            }
        });

        var get = await _s3.GetObjectAsync(_bucket, key);
        Assert.Equal(bytes.Length, get.ContentLength);
    }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3MultipartTests.cs ==========

// ========== BEGIN: ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3TestClient.cs ==========
using Amazon;
using Amazon.Runtime;
using Amazon.S3;
using Microsoft.Extensions.Configuration;

namespace EleonS3.Test.Tests;
public static class S3TestClient
{
    public static IAmazonS3 Create(IConfiguration config)
    {
        var section = config.GetSection("S3");
        var credentials = new BasicAWSCredentials(
            section["AccessKey"],
            section["SecretKey"]
        );

        var clientConfig = new AmazonS3Config
        {
            ServiceURL = section["Endpoint"],
            ForcePathStyle = bool.Parse(section["ForcePathStyle"] ?? "true"),
            UseHttp = bool.Parse(section["UseHttp"] ?? "true"),
            RegionEndpoint = RegionEndpoint.GetBySystemName(section["Region"]),
        };

        return new AmazonS3Client(credentials, clientConfig);
    }
}
// ========== END:   ..\eleonsoft\server\hosts\eleons3\EleonS3.Test\Tests\S3TestClient.cs ==========

