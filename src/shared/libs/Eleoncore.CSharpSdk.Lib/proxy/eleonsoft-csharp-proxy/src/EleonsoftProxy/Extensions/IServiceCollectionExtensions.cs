/*
 * Admin API
 *
 * No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)
 *
 * The version of the OpenAPI document: v1
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

using System;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging.Abstractions;
using EleonsoftProxy.Client;
using SharedModule.HttpApi.Helpers;

namespace EleonsoftProxy.Extensions
{
    public static class ServiceCollectionExtensions
    {
        public static IServiceCollection AddApi(this IServiceCollection services, Action<ApiClientOptions> configure)
        {
            if (services == null)
            {
                throw new ArgumentNullException(nameof(services));
            }

            if (configure == null)
            {
                throw new ArgumentNullException(nameof(configure));
            }

            var options = new ApiClientOptions();
            configure(options);

            ApplyOptions(services, options);

            return services;
        }

        private static void ApplyOptions(IServiceCollection services, ApiClientOptions options)
        {
            var jsonOptions = HostConfiguration.ConfigureApiJsonOptions();
            options.JsonOptionsConfigurator?.Invoke(jsonOptions);

            var sdkConfig = options.SdkConfig;
            var configuredBaseAddress = ResolveBaseAddress(options);

            if (string.IsNullOrWhiteSpace(sdkConfig.BaseHost))
            {
                if (configuredBaseAddress != null)
                {
                    ApplyBaseAddress(sdkConfig, configuredBaseAddress);
                }
                else
                {
                    sdkConfig.BaseHost = ClientUtils.BASE_ADDRESS;
                }
            }

            if (options.Tokens.Count > 0 && !sdkConfig.UseApiAuthorization && !sdkConfig.UseOAuthAuthorization)
            {
                sdkConfig.UseOAuthAuthorization = true;
            }

            ApiConfigurator.Initialize("EleonsoftProxy", new ApiConfigurator(sdkConfig, NullLoggerFactory.Instance, jsonOptions));
            services.AddEleonsoftProxyApi();
            services.AddHttpContextInitializator();

            RegisterHttpClients(services, options, configuredBaseAddress);
        }

        private static Uri? ResolveBaseAddress(ApiClientOptions options)
        {
            if (options.HttpClientConfigurators.Count == 0)
            {
                return null;
            }

            using var client = new HttpClient
            {
                BaseAddress = new Uri(ClientUtils.BASE_ADDRESS)
            };

            foreach (var configure in options.HttpClientConfigurators)
            {
                configure(client);
            }

            return client.BaseAddress;
        }

        private static void ApplyBaseAddress(EleoncoreSdkConfig sdkConfig, Uri baseAddress)
        {
            sdkConfig.BaseHost = baseAddress.GetLeftPart(UriPartial.Authority);
            var path = baseAddress.AbsolutePath;
            sdkConfig.BasePath = path == "/" ? string.Empty : path.TrimEnd('/');
        }

        private static void RegisterHttpClients(IServiceCollection services, ApiClientOptions options, Uri? baseAddress)
        {
            if (options.HttpClientConfigurators.Count == 0 && options.HttpClientBuilderConfigurators.Count == 0)
            {
                return;
            }

            var builder = services.AddHttpClient("EleonsoftProxy", client =>
            {
                if (baseAddress != null)
                {
                    client.BaseAddress = baseAddress;
                }

                foreach (var configure in options.HttpClientConfigurators)
                {
                    configure(client);
                }
            });

            foreach (var configure in options.HttpClientBuilderConfigurators)
            {
                configure(builder);
            }
        }
    }
}
